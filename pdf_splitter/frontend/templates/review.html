{% extends "base.html" %}

{% block title %}Review Document Boundaries - PDF Splitter{% endblock %}

{% block content %}
<div x-data="documentReview()" x-init="init()" class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Review Document Boundaries</h2>
        <p class="text-gray-600 mt-1">Review and adjust the detected document boundaries before splitting</p>

        <!-- Loading State -->
        <div x-show="loading" class="mt-4">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="animate-pulse">
                    <div class="h-4 bg-gray-300 rounded w-1/4 mb-4"></div>
                    <div class="space-y-3">
                        <div class="h-20 bg-gray-300 rounded"></div>
                        <div class="h-20 bg-gray-300 rounded"></div>
                        <div class="h-20 bg-gray-300 rounded"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div x-show="error" class="mt-4 bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex">
                <svg class="w-5 h-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                <div>
                    <h3 class="text-sm font-medium text-red-800">Error Loading Documents</h3>
                    <p class="text-sm text-red-700 mt-1" x-text="error"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div x-show="!loading && !error" class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Document List -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-lg shadow">
                <!-- Document Count Header -->
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">
                            Detected Documents (<span x-text="documents.length"></span>)
                        </h3>
                        <div class="text-sm text-gray-500">
                            <span x-text="selectedDocuments.length"></span> selected
                        </div>
                    </div>
                </div>

                <!-- Document Cards -->
                <div class="p-6 space-y-4">
                    <template x-for="(doc, index) in documents" :key="doc.id">
                        <div
                            class="border rounded-lg p-4 cursor-pointer transition-all duration-200 hover:shadow-md"
                            :class="{
                                'border-blue-500 bg-blue-50': isSelected(doc),
                                'border-gray-200': !isSelected(doc)
                            }"
                            @click="toggleDocumentSelection(doc)"
                        >
                            <!-- Document Header -->
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3">
                                        <!-- Selection Checkbox -->
                                        <input
                                            type="checkbox"
                                            :checked="isSelected(doc)"
                                            @click.stop
                                            @change="toggleDocumentSelection(doc)"
                                            class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                                        >

                                        <!-- Document Title -->
                                        <h4 class="font-semibold text-lg text-gray-900">
                                            Document <span x-text="index + 1"></span>
                                        </h4>

                                        <!-- Document Type Badge -->
                                        <span
                                            class="px-2 py-1 text-xs font-medium rounded-full"
                                            :class="getDocumentTypeColor(doc.document_type)"
                                            x-text="formatDocumentType(doc.document_type)"
                                        ></span>
                                    </div>

                                    <!-- Document Metadata -->
                                    <div class="mt-2 space-y-1 text-sm text-gray-600">
                                        <div class="flex items-center space-x-4">
                                            <span class="flex items-center">
                                                <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                </svg>
                                                Pages <span x-text="doc.start_page + 1"></span>-<span x-text="doc.end_page + 1"></span>
                                            </span>
                                            <span class="flex items-center">
                                                <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                                </svg>
                                                <span x-text="doc.end_page - doc.start_page + 1"></span> pages
                                            </span>
                                            <span class="flex items-center" x-show="doc.confidence !== undefined">
                                                <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                                <span x-text="Math.round(doc.confidence * 100)"></span>% confidence
                                            </span>
                                        </div>

                                        <!-- Document Title (if available) -->
                                        <p x-show="doc.title" class="font-medium text-gray-700" x-text="doc.title"></p>

                                        <!-- Preview Text -->
                                        <p x-show="doc.preview_text" class="text-gray-600 line-clamp-2" x-text="doc.preview_text"></p>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex items-center space-x-2 ml-4">
                                    <button
                                        @click.stop="togglePreview(doc)"
                                        class="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors duration-200"
                                        :title="doc.showPreview ? 'Hide Preview' : 'Show Preview'"
                                    >
                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Preview Section -->
                            <div x-show="doc.showPreview" x-transition class="mt-4 pt-4 border-t border-gray-200">
                                <div class="flex justify-center">
                                    <div class="max-w-sm">
                                        <img
                                            :src="getPreviewUrl(doc)"
                                            :alt="'Preview of Document ' + (index + 1)"
                                            class="w-full rounded-lg border shadow-sm"
                                            @error="handlePreviewError($event, doc)"
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Empty State -->
                    <div x-show="documents.length === 0" class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No documents detected</h3>
                        <p class="mt-1 text-sm text-gray-500">
                            No document boundaries were found in this PDF. You can manually add boundaries using the action panel.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Panel -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow p-6 sticky top-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Actions</h3>

                <!-- Quick Actions -->
                <div class="space-y-3 mb-6">
                    <button
                        @click="addDocumentBoundary()"
                        class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200 flex items-center justify-center space-x-2"
                    >
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span>Add Boundary</span>
                    </button>

                    <button
                        @click="mergeSelectedDocuments()"
                        :disabled="selectedDocuments.length < 2"
                        class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200 flex items-center justify-center space-x-2"
                    >
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                        </svg>
                        <span>Merge Selected</span>
                    </button>

                    <button
                        @click="deleteSelectedDocuments()"
                        :disabled="selectedDocuments.length === 0"
                        class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:ring-2 focus:ring-red-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200 flex items-center justify-center space-x-2"
                    >
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        <span>Delete Selected</span>
                    </button>
                </div>

                <!-- Document Info -->
                <div class="border-t border-gray-200 pt-4 mb-6">
                    <h4 class="text-sm font-medium text-gray-900 mb-2">Document Summary</h4>
                    <div class="space-y-2 text-sm text-gray-600">
                        <div class="flex justify-between">
                            <span>Total Documents:</span>
                            <span x-text="documents.length" class="font-medium"></span>
                        </div>
                        <div class="flex justify-between">
                            <span>Selected:</span>
                            <span x-text="selectedDocuments.length" class="font-medium"></span>
                        </div>
                        <div class="flex justify-between" x-show="documents.length > 0">
                            <span>Total Pages:</span>
                            <span x-text="getTotalPageCount()" class="font-medium"></span>
                        </div>
                    </div>
                </div>

                <!-- Split Action -->
                <div class="border-t border-gray-200 pt-4">
                    <button
                        @click="executeSplit()"
                        :disabled="documents.length === 0"
                        class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed font-semibold transition-colors duration-200 flex items-center justify-center space-x-2"
                    >
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                        </svg>
                        <span>Split PDF</span>
                    </button>

                    <p class="text-xs text-gray-500 mt-2 text-center">
                        This will create separate PDF files for each document
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Area -->
<div id="notifications" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

<script>
function documentReview() {
    return {
        documents: [],
        selectedDocuments: [],
        sessionId: '{{ session_id }}',
        loading: true,
        error: null,

        async init() {
            await this.loadDocuments();
        },

        async loadDocuments() {
            try {
                this.loading = true;
                this.error = null;

                const response = await fetch(`/api/splits/${this.sessionId}/proposal`);

                if (!response.ok) {
                    throw new Error(`Failed to load documents: ${response.statusText}`);
                }

                const data = await response.json();

                // Transform the data to include UI-specific properties
                this.documents = data.segments.map(segment => ({
                    ...segment,
                    showPreview: false
                }));

            } catch (error) {
                console.error('Error loading documents:', error);
                this.error = error.message;
            } finally {
                this.loading = false;
            }
        },

        isSelected(doc) {
            return this.selectedDocuments.some(selected => selected.id === doc.id);
        },

        toggleDocumentSelection(doc) {
            if (this.isSelected(doc)) {
                this.selectedDocuments = this.selectedDocuments.filter(selected => selected.id !== doc.id);
            } else {
                this.selectedDocuments.push(doc);
            }
        },

        togglePreview(doc) {
            doc.showPreview = !doc.showPreview;
        },

        getPreviewUrl(doc) {
            return `/api/splits/${this.sessionId}/preview/${doc.id}`;
        },

        handlePreviewError(event, doc) {
            console.error('Preview failed to load for document:', doc.id);
            event.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzZiNzI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIFByZXZpZXcgQXZhaWxhYmxlPC90ZXh0Pjwvc3ZnPg==';
        },

        getDocumentTypeColor(type) {
            const colors = {
                'letter': 'bg-blue-100 text-blue-800',
                'email': 'bg-green-100 text-green-800',
                'report': 'bg-purple-100 text-purple-800',
                'invoice': 'bg-yellow-100 text-yellow-800',
                'memo': 'bg-indigo-100 text-indigo-800',
                'contract': 'bg-red-100 text-red-800',
                'form': 'bg-pink-100 text-pink-800',
                'other': 'bg-gray-100 text-gray-800'
            };
            return colors[type] || colors['other'];
        },

        formatDocumentType(type) {
            return type.charAt(0).toUpperCase() + type.slice(1);
        },

        getTotalPageCount() {
            return this.documents.reduce((total, doc) => {
                return total + (doc.end_page - doc.start_page + 1);
            }, 0);
        },

        addDocumentBoundary() {
            // Placeholder for Sprint 5
            this.showNotification('Add boundary functionality will be implemented in Sprint 5', 'info');
        },

        mergeSelectedDocuments() {
            if (this.selectedDocuments.length < 2) {
                this.showNotification('Please select at least 2 documents to merge', 'warning');
                return;
            }

            // Placeholder for Sprint 5
            this.showNotification('Merge functionality will be implemented in Sprint 5', 'info');
        },

        deleteSelectedDocuments() {
            if (this.selectedDocuments.length === 0) {
                this.showNotification('Please select documents to delete', 'warning');
                return;
            }

            // Placeholder for Sprint 5
            this.showNotification('Delete functionality will be implemented in Sprint 5', 'info');
        },

        async executeSplit() {
            if (this.documents.length === 0) {
                this.showNotification('No documents to split', 'warning');
                return;
            }

            try {
                this.showNotification('Starting PDF split...', 'info');

                const response = await fetch(`/api/splits/${this.sessionId}/execute`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`Split failed: ${response.statusText}`);
                }

                const result = await response.json();

                this.showNotification('Split started successfully! Redirecting...', 'success');

                // Redirect to results page
                setTimeout(() => {
                    window.location.href = `/results/${result.split_id}`;
                }, 1500);

            } catch (error) {
                console.error('Split execution failed:', error);
                this.showNotification(`Split failed: ${error.message}`, 'error');
            }
        },

        showNotification(message, type = 'info') {
            // Use the global notification system
            if (window.notify) {
                window.notify.show(message, type);
            } else {
                // Fallback to alert if notification system not available
                alert(message);
            }
        }
    }
}
</script>
{% endblock %}
